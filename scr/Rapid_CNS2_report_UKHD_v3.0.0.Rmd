---
output:
  pdf_document:
    latex_engine: pdflatex
    includes:
      header: |
        \usepackage{palatino}
        \renewcommand{\familydefault}{\rmdefault}
        \fontfamily{ppl}\selectfont
        \usepackage{fancyhdr}
        \pagestyle{fancy}
        \fancyhf{}
        \fancyhead[L]{\includegraphics[height=0.5in]{rapid_cns2_logo.png}}
        \fancyhead[R]{\includegraphics[height=0.5in]{ukhd_logo.png} \quad \thepage}
        \fancyfoot[C]{\small\textit{Generated using Rapid-CNS² pipeline - RESEARCH USE ONLY}}
        \renewcommand{\headrulewidth}{0.4pt}
        \renewcommand{\footrulewidth}{0.4pt}
    geometry: margin=0.2in
  html_document:
    df_print: paged
    toc: true
    toc_float: true
params:
  logo_file: null
  institution_logo: null
always_allow_html: true
---
<style type="text/css">
    body{
  font-size: 14pt;
  text-align: justify;
  font-family: "Palatino", "Palatino Linotype", "Palatino LT STD", "Book Antiqua", Georgia, serif;
  }

  .header {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #ccc;
    margin-bottom: 20px;
    gap: 20px;
  }
  
                .logo {
                height: 120px;
                width: auto;
              }
              
              .sample-info {
                font-size: 1em;
                color: #666;
                margin: 10px 0;
              }
              
              .smaller-text {
                font-size: 0.85em;
              }
  
  .footer {
    text-align: center;
    font-style: italic;
    font-size: 12px;
    color: #666;
    border-top: 1px solid #ccc;
    padding: 10px;
    margin-top: 20px;
  }
  
  .research-warning {
    background-color: #ffebee;
    border: 2px solid #f44336;
    color: #d32f2f;
    padding: 20px;
    text-align: center;
    font-size: 18px;
    font-weight: bold;
    margin: 20px 0;
    border-radius: 5px;
  }
  
    h1, h2, h3, h4 {
    margin-top: 40px;
    margin-bottom: 20px;
    padding-top: 20px;
    border-top: 1px solid #eee;
  }

  h1:first-child, h2:first-child, h3:first-child, h4:first-child {
    border-top: none;
    margin-top: 20px;
  }

  p {
    margin-bottom: 15px;
    line-height: 1.6;
  }

  .section {
    margin-bottom: 40px;
    padding-bottom: 20px;
  }
  
  .smaller-text h4 {
    margin-top: 10px;
    margin-bottom: 5px;
    padding-top: 5px;
  }
  
  .smaller-text p {
    margin-bottom: 5px;
    line-height: 1.3;
  }
</style>

```{r logo_paths, echo=FALSE, results='asis'}
# Get absolute paths for logos in working directory
rapid_logo_path <- file.path(getwd(), "rapid_cns2_logo.png")
ukhd_logo_path <- file.path(getwd(), "ukhd_logo.png")
```

<div class="header">
  <img src="`r rapid_logo_path`" alt="Rapid-CNS² Logo" class="logo">
  <img src="`r ukhd_logo_path`" alt="Institution Logo" class="logo">
</div>

<div class="research-warning">
  RESEARCH USE ONLY
</div>



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(kableExtra)
library(ggplot2)
```

```{r params_setup, echo=FALSE}
# Use the logo parameters from YAML header
# To use custom logos, modify the params section in the YAML header above
# Example: 
# params:
#   logo_file: "rapid_cns2_logo.png"
#   institution_logo: "your_institution_logo.png"
logo_file <- params$logo_file
institution_logo <- params$institution_logo
```

```{r research_use_only, echo=FALSE, results='asis'}
# This section is handled by HTML header for HTML output
# For PDF output, the LaTeX header handles this
```

```{r check_platform, echo=FALSE}
platform <- "Unknown"
if (seq!="false"){
    platform <- seq
}
if (seq=="F") {
    platform <- "MinION/GridION"
}
if (seq=="P") {
    platform <- "PromethION"
}
if (seq=="P2S") {
    platform <- "P2 Solo"
}
if (seq=="P2i") {
    platform <- "P2 Integrated"
}

if (seq=="GXB") {
    platform <- "GridION"
}


```

<div class="section">

## **RapidCNS^2^ Report**

<div class="sample-info">
**Sample ID:** `r sample`  
**Patient:** `r patient`
</div>

#### This report was generated by **Rapid-CNS^2^ (Nextflow pipeline Rapid-CNS2_nf `r params$software_ver`)** and is intended for research use only.  \
#### Frozen tumour tissue was prepared and processed using the SQK-LSK114 Ligation Sequencing Kit from Oxford Nanopore Technologies. 160 gene regions from the NPHD panel were targeted using an adaptive sampling approach on the `r platform` platform. Data was analysed by the custom Rapid-CNS^2^ pipeline. Comprehensive analysis of CNS tumours using Rapid-CNS^2^ is a research tool currently under development. It has not been clinically validated in sufficiently large cohorts. Interpretation and implementation of the results in a clinical setting is in the sole responsibility of the treating physician.

</div>

<div class="section">

## On-target coverage
```{r,echo=FALSE,out.width="75%",warning=FALSE, fig.align='center'}
df <- read.delim(coverage)
df$Reads <- "All"
df$Reads[endsWith(df$chrom,"_region")] <- "On_target"
df$chrom <- gsub("_region","",df$chrom)
df$mean <- as.numeric(df$mean)
df$chrom[df$chrom=="chr1"] <- "chr01"
df$chrom[df$chrom=="chr2"] <- "chr02"
df$chrom[df$chrom=="chr3"] <- "chr03"
df$chrom[df$chrom=="chr4"] <- "chr04"
df$chrom[df$chrom=="chr5"] <- "chr05"
df$chrom[df$chrom=="chr6"] <- "chr06"
df$chrom[df$chrom=="chr7"] <- "chr07"
df$chrom[df$chrom=="chr8"] <- "chr08"
df$chrom[df$chrom=="chr9"] <- "chr09"

df <- df[order(df$chrom),]

df$chrom <- as.character(df$chrom)

df <- df[which(df$chrom!="chrM"),]

df$chrom <- as.factor(df$chrom)
levels(df$chrom) <- unique(df$chrom)
ggplot2::ggplot(data=df, 
  aes(x=chrom,y=mean,color=Reads)) + 
  geom_point(size=3) + 
  theme_minimal() + 
  ylab("Mean coverage") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1,size = 10), axis.title.y = element_text(size=10)) + 
  ylim(0,max(df$mean))+ scale_color_manual(values = c("#FF5A5F","#0B3954")) + 
  xlab("Chromosome") +theme(text=element_text(family="sans")) + 
  theme(panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = 1))
```
</div>

<div class="section">

## Mutations

````{=html}
```{r, echo=FALSE, results='asis', eval=inc_igvreport}
xfun::file_string(igv_report)
```
````

```{r,echo=FALSE, out.width="100%", warning=FALSE, eval=exc_igvreport}
d <- read.csv(mutations)
kable(d, booktabs = TRUE) %>%
  kable_styling(font_size=14, latex_options = c("HOLD_position","scale_down"))
```


</div>

<div class="section">

## Copy number profile


```{r, echo=FALSE, warning=FALSE}
knitr::include_graphics(cnv_plot)
```
</div>

<div class="section">

```{r, echo=FALSE}
x <- rf_details
oob <- read.delim(x,header = F, sep = ":")
mc <- read.delim(votes,sep=" ")
```

## Rapid CNS^2^ Methylation classification
#### Methylation-based classification is based on `r as.integer(oob[1,2])` sites. The Brier score of this ad-hoc classifier is `r paste0(round(as.numeric(oob[3,2])*100,digits=1),"%")`. Using this classifier, the sample has been classified as  **`r rownames(mc[which.max(mc$Recalibrated_Frequency),])`**. This prediction has a confidence score of **`r paste0(round(as.numeric(mc$cal_Freq[which.max(mc$cal_Freq)]),digits=1),"%")`**. The calibrated score distribution for the Top 10 entities is given below.

```{r,echo=FALSE,warning=FALSE}
mc$methClass <- rownames(mc)
ggplot(data=mc, aes(x=methClass, y=Recalibrated_Frequency)) +
  geom_bar(stat="identity", fill="#dc143c") +
  coord_flip() +
  scale_x_discrete(limits=mc[order(mc$Recalibrated_Frequency,decreasing=T),]$methClass[10:1]) +
  ylim(0,100) +
  ylab("confidence score (%)") + xlab("methylation class") +
  theme_classic() + theme(aspect.ratio=1) +theme(text=element_text(family="sans")) +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1))

```

</div>

<div class="section">

## MGMT promoter methylation \
#### Average coverage of MGMT is: **`r cov`**x.\

```{r setup2, echo=FALSE}
show_mgmt <- FALSE
### if methylartist and mgmt exist
if (methylartist_status == "true" & mgmt_status == "true")
show_mgmt <- TRUE
```

```{r conditional_block, echo=FALSE, results='asis', eval=show_mgmt}
mgmt_file <- read.csv(mgmt)
avg <- mgmt_file$average
avg <- round(as.numeric(avg), 2)
avg <- paste0(avg,"%")
status <- mgmt_file$status
cat("#### MGMT promoter methylation status is assessed based on a logistic regression based prediction model that considers 137 most predictive CpG sites in the MGMT promoter region. The cutoff is assigned as 25%")
cat("\n\n#### Average methylation = ")
cat(avg)
cat("\n\n#### Predicted MGMT promoter status = ")
cat(status)
```

```{r setup3, echo=FALSE}
mgmt_too_low <- FALSE
## if methylartist and mgmt exist
if (!file.exists(methylartist_plot) 
    & !file.exists(mgmt))
mgmt_too_low <- TRUE
```
```{r, echo=FALSE, warning=FALSE, results='asis', eval=mgmt_too_low}
cat("#### MGMT promoter methylation status was not assessed in this sample due to sequence coverage at the MGMT promter region being too low.")
```

## MGMT Promoter methylation plot:
```{r, echo=FALSE, out.width="100%",warning=FALSE, eval=show_mgmt}
knitr::include_graphics(methylartist_plot)
```

```{r, echo=FALSE, warning=FALSE, results='asis', eval=mgmt_too_low}
cat("#### An MGMT promoter plot was not produced in this sample due to sequence coverage at the MGMT site being too low.")
```

<div class="smaller-text">

#### The Rapid CNS2 classification and report generation followed the protocol designed and published by Patel _et_ _al._ (2022) and Patel _et_ _al._ (2025).

#### Patel, A., Dogan, H., Payne, A., Krause, E., Sievers, P., Schoebe, N., Schrimpf, D., Blume, C., Stichel, D., Holmes, N., Euskirchen, P., Hench, J., Frank, S., Rosenstiel-Goidts, V., Ratliff, M., Etminan, N., Unterberg, A., Dieterich, C., Herold-Mende, C., Pfister, S. M., … Sahm, F. (2022). Rapid-CNS^2^: rapid comprehensive adaptive nanopore-sequencing of CNS tumors, a proof-of-concept study. _Acta_ _neuropathologica_, _143_(5), 609–612. https://doi.org/10.1007/s00401-022-02415-6 \

#### Patel, A., Göbel, K., Ille, S. et al. Prospective, multicenter validation of a platform for rapid molecular profiling of central nervous system tumors. *Nature Medicine* 31, 1567–1577 (2025). [https://doi.org/10.1038/s41591-025-03562-5](https://www.nature.com/articles/s41591-025-03562-5)

#### **The information contained with this report is intended for research use only and is not for use in diagnostic procedures.**

#### For any questions, please contact:  
#### **Areeba Patel, PhD**  
#### Department of Neuropathology, German Cancer Research Center  
#### a.patel@dkfz.de  

#### **Prof Dr. Dr. med Felix Sahm**  
#### Head of Molecular Neuropathology, University Hospital Heidelberg  
#### felix.sahm@med.uni-heidelberg.de  \

#### Report generated on `r format(Sys.time(), '%d %B, %Y at %H:%M')`

</div>

<div class="footer">
  Generated using Rapid-CNS² pipeline - RESEARCH USE ONLY
</div>

